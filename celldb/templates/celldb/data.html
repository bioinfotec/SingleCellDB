{% extends 'celldb/base.html' %} {% load static %} {% block content %}

<div class="card">
  <div class="card-body">
    <div class="container">
      <div class="row justify-content-between">
        <h3 class="card-title col-md-4 mb-2">Data</h3>
        <div class="col-md-4 mb-2">
          <label for="cellTypeFilter">Type</label>
          <select id="cellTypeFilter" class="mb-2" style="width: 25%">
            <option value="">All</option>
            <option value="Hep">Hep</option>
            <option value="HSC">HSC</option>
            <option value="cDC">cDC</option>
            <option value="pDC">pDC</option>
            <option value="Monocytes">Monocytes</option>
            <option value="KC">KC</option>
            <option value="Macrophages">Macrophages</option>
            <option value="Endo">Endo</option>
            <option value="B">B</option>
            <option value="T+NK">T+NK</option>
            <option value="Chol">Chol</option>
          </select>
        </div>
        <button
          id="downloadBtn"
          class="btn btn-primary col-md-2 mb-2"
          style="height: 50%; width: 50%"
        >
          Download Data
        </button>
      </div>
      <div class="row">
        <div class="col-md-12">
          <table id="example" class="table table-hover" style="width: 100%">
            <thead>
              <tr>
                <th style="text-align: right">ID</th>
                <th style="text-align: right">Barcode</th>
                <th style="text-align: right">Type</th>
                <th style="text-align: right">Zone</th>
                <th style="text-align: right">Run</th>
                <th style="text-align: right">Time</th>
                <th style="text-align: right">X</th>
                <th style="text-align: right">Y</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"
  integrity="sha512-WNLxfP/8cVYL9sj8Jnp6et0BkubLP31jhTG9vhL/F5uEZmg5wEzKoXp1kJslzPQWwPT1eyMiSxlKCgzHLOTOTQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
  crossorigin="anonymous"
></script>
<script src="{% static 'celldb/js/cdn.datatables.net_1.13.4_js_jquery.dataTables.min.js' %}"></script>
<script src="{% static 'celldb/js/cdn.datatables.net_1.13.4_js_dataTables.bootstrap5.min.js' %}"></script>
<script>
  $(document).ready(function () {
    var table = $("#example").DataTable({
      ajax: {
        url: "/api/tran/all",
        dataSrc: "",
      },
      columns: [
        { data: "data_id" },
        { data: "cell_barcode" },
        { data: "cell_type" },
        { data: "zone" },
        { data: "run_id" },
        { data: "time_point" },
        { data: "umap_x" },
        { data: "umap_y" },
      ],
      paging: true,
      deferRender: true,
    });
    $("#cellTypeFilter").on("change", function () {
      var selectedCellType = $(this).val();

      table.column(2).search(selectedCellType).draw();
    });
  });
</script>
<script>
  $(document).ready(function () {
    // ...

    // 添加按钮点击事件处理函数
    $("#downloadBtn").click(function () {
      // 获取当前表格中的数据
      var table = $("#example").DataTable();
      var filteredData = table.rows({ search: "applied" }).data().toArray();

      // 执行下载操作，可以根据需要自定义实现
      downloadData(filteredData);
    });

    // ...
  });

  // 下载数据的函数，示例使用 console.log 输出数据
  function downloadData(data) {
    // 将数据转换为文本格式
    var textData = JSON.stringify(data);
    // 转化为csv格式
    var csv =
      "data_id,cell_barcode,cell_type,zone,run_id,time_point,umap_x,umap_y\n";
    var csvRows = data.map(function (row) {
      return [
        row.data_id,
        row.cell_barcode,
        row.cell_type,
        row.zone,
        row.run_id,
        row.time_point,
        row.umap_x,
        row.umap_y,
      ].join(",");
    });
    csv += csvRows.join("\n");
    var blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;",
    });
    // 创建一个 <a> 元素
    var link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", "data.csv");

    // 模拟点击下载链接
    link.click();
  }
</script>
{% endblock %}
